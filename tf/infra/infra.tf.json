{
  "resource": {
    "digitalocean_droplet": {
      "serverams31": {
        "image": "ubuntu-18-04-x64",
        "name": "${random_pet.serverams31.id}",
        "private_networking": true,
        "region": "ams3",
        "size": "s-1vcpu-1gb",
        "ssh_keys": [
          "${digitalocean_ssh_key.smintz-0.id}"
        ],
        "tags": [
          "server"
        ],
        "user_data": "#!/bin/bash\napt-get update\napt-get install -y unzip curl jq dnsutils\napt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository  \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" \napt-get update\napt-get install -y docker-ce docker-ce-cli containerd.io\nuseradd --system --home /etc/consul.d --shell /bin/false consul\nmkdir -p /etc/consul.d\nchown root:root /etc/consul.d\nchmod 0755 /etc/consul.d\nmkdir -p /opt/consul\nchown consul:consul /opt/consul\nchmod 0755 /opt/consul\ncurl -L https://releases.hashicorp.com/consul/1.7.1/consul_1.7.1_linux_amd64.zip -o /tmp/consul-1.7.1.zip\nchown root:root /tmp/consul-1.7.1.zip\nchmod 0644 /tmp/consul-1.7.1.zip\nunzip -x /tmp/consul-1.7.1.zip -d /usr/local/bin\nconsul -autocomplete-install\ncomplete -C /usr/local/bin/consul consul\ncat <<FILE_CONTENT | tee /etc/consul.d/config.hcl\nui = true\nbind = \"0.0.0.0\"\nadvertise_addr = \"{{GetPublicIP}}\"\ndatacenter = \"ams3\"\ndata_dir = \"/opt/consul\"\nFILE_CONTENT\nchown consul:consul /etc/consul.d/config.hcl\nchmod 0640 /etc/consul.d/config.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/server.hcl\nserver = true\nbootstrap_expect = 3\nFILE_CONTENT\nchown consul:consul /etc/consul.d/server.hcl\nchmod 0640 /etc/consul.d/server.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/join_lan.hcl\nretry_join = [\"provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\"]\nFILE_CONTENT\nchown consul:consul /etc/consul.d/join_lan.hcl\nchmod 0640 /etc/consul.d/join_lan.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/consul.service\n[Unit]\nAfter=network-online.target\nDescription=HashiCorp Consul - A service mesh solution\nDocumentation=https://www.consul.io/\nRequires=network-online.target\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/\nGroup=consul\nKillMode=process\nLimitNOFILE=65536\nRestart=on-failure\nType=notify\nUser=consul\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/consul.service\nchmod 0644 /etc/systemd/system/consul.service\nsystemctl start consul\nsystemctl enable consul\nmkdir -p /etc/nomad.d\nchown root:root /etc/nomad.d\nchmod 0755 /etc/nomad.d\nmkdir -p /opt/nomad/data\nchown root:root /opt/nomad/data\nchmod 0755 /opt/nomad/data\ncurl -L https://releases.hashicorp.com/nomad/0.10.0/nomad_0.10.0_linux_amd64.zip -o /tmp/nomad-0.10.0.zip\nchown root:root /tmp/nomad-0.10.0.zip\nchmod 0644 /tmp/nomad-0.10.0.zip\nunzip -x /tmp/nomad-0.10.0.zip -d /usr/local/bin\nrm /tmp/nomad-0.10.0.zip\ncat <<FILE_CONTENT | tee /etc/nomad.d/nomad.hcl\nadvertise {\n    http = \"{{GetPublicIP}}\"\n    rpc = \"{{GetPublicIP}}\"\n    serf = \"{{GetPublicIP}}\"\n}\n\nFILE_CONTENT\nchown root:root /etc/nomad.d/nomad.hcl\nchmod 0644 /etc/nomad.d/nomad.hcl\ncat <<FILE_CONTENT | tee /etc/nomad.d/datacenter.hcl\ndatacenter = ams3\nFILE_CONTENT\nchown root:root /etc/nomad.d/datacenter.hcl\nchmod 0644 /etc/nomad.d/datacenter.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/nomad.service\n[Unit]\nDescription=nomad\nDocumentation=http://localhost\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/nomad agent -server -bootstrap-expect=3 -data-dir=/opt/nomad/data -config=/etc/nomad.d provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\nRestart=on-failure\nType=notify\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/nomad.service\nchmod 0644 /etc/systemd/system/nomad.service\nsystemctl start nomad\nsystemctl enable nomad",
        "lifecycle": {
          "ignore_changes": [
            "user_data"
          ]
        }
      },
      "serverams32": {
        "image": "ubuntu-18-04-x64",
        "name": "${random_pet.serverams32.id}",
        "private_networking": true,
        "region": "ams3",
        "size": "s-1vcpu-1gb",
        "ssh_keys": [
          "${digitalocean_ssh_key.smintz-0.id}"
        ],
        "tags": [
          "server"
        ],
        "user_data": "#!/bin/bash\napt-get update\napt-get install -y unzip curl jq dnsutils\napt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository  \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" \napt-get update\napt-get install -y docker-ce docker-ce-cli containerd.io\nuseradd --system --home /etc/consul.d --shell /bin/false consul\nmkdir -p /etc/consul.d\nchown root:root /etc/consul.d\nchmod 0755 /etc/consul.d\nmkdir -p /opt/consul\nchown consul:consul /opt/consul\nchmod 0755 /opt/consul\ncurl -L https://releases.hashicorp.com/consul/1.7.1/consul_1.7.1_linux_amd64.zip -o /tmp/consul-1.7.1.zip\nchown root:root /tmp/consul-1.7.1.zip\nchmod 0644 /tmp/consul-1.7.1.zip\nunzip -x /tmp/consul-1.7.1.zip -d /usr/local/bin\nconsul -autocomplete-install\ncomplete -C /usr/local/bin/consul consul\ncat <<FILE_CONTENT | tee /etc/consul.d/config.hcl\nui = true\nbind = \"0.0.0.0\"\nadvertise_addr = \"{{GetPublicIP}}\"\ndatacenter = \"ams3\"\ndata_dir = \"/opt/consul\"\nFILE_CONTENT\nchown consul:consul /etc/consul.d/config.hcl\nchmod 0640 /etc/consul.d/config.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/server.hcl\nserver = true\nbootstrap_expect = 3\nFILE_CONTENT\nchown consul:consul /etc/consul.d/server.hcl\nchmod 0640 /etc/consul.d/server.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/join_lan.hcl\nretry_join = [\"provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\"]\nFILE_CONTENT\nchown consul:consul /etc/consul.d/join_lan.hcl\nchmod 0640 /etc/consul.d/join_lan.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/consul.service\n[Unit]\nAfter=network-online.target\nDescription=HashiCorp Consul - A service mesh solution\nDocumentation=https://www.consul.io/\nRequires=network-online.target\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/\nGroup=consul\nKillMode=process\nLimitNOFILE=65536\nRestart=on-failure\nType=notify\nUser=consul\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/consul.service\nchmod 0644 /etc/systemd/system/consul.service\nsystemctl start consul\nsystemctl enable consul\nmkdir -p /etc/nomad.d\nchown root:root /etc/nomad.d\nchmod 0755 /etc/nomad.d\nmkdir -p /opt/nomad/data\nchown root:root /opt/nomad/data\nchmod 0755 /opt/nomad/data\ncurl -L https://releases.hashicorp.com/nomad/0.10.0/nomad_0.10.0_linux_amd64.zip -o /tmp/nomad-0.10.0.zip\nchown root:root /tmp/nomad-0.10.0.zip\nchmod 0644 /tmp/nomad-0.10.0.zip\nunzip -x /tmp/nomad-0.10.0.zip -d /usr/local/bin\nrm /tmp/nomad-0.10.0.zip\ncat <<FILE_CONTENT | tee /etc/nomad.d/nomad.hcl\nadvertise {\n    http = \"{{GetPublicIP}}\"\n    rpc = \"{{GetPublicIP}}\"\n    serf = \"{{GetPublicIP}}\"\n}\n\nFILE_CONTENT\nchown root:root /etc/nomad.d/nomad.hcl\nchmod 0644 /etc/nomad.d/nomad.hcl\ncat <<FILE_CONTENT | tee /etc/nomad.d/datacenter.hcl\ndatacenter = ams3\nFILE_CONTENT\nchown root:root /etc/nomad.d/datacenter.hcl\nchmod 0644 /etc/nomad.d/datacenter.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/nomad.service\n[Unit]\nDescription=nomad\nDocumentation=http://localhost\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/nomad agent -server -bootstrap-expect=3 -data-dir=/opt/nomad/data -config=/etc/nomad.d provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\nRestart=on-failure\nType=notify\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/nomad.service\nchmod 0644 /etc/systemd/system/nomad.service\nsystemctl start nomad\nsystemctl enable nomad",
        "lifecycle": {
          "ignore_changes": [
            "user_data"
          ]
        }
      },
      "serverams33": {
        "image": "ubuntu-18-04-x64",
        "name": "${random_pet.serverams33.id}",
        "private_networking": true,
        "region": "ams3",
        "size": "s-1vcpu-1gb",
        "ssh_keys": [
          "${digitalocean_ssh_key.smintz-0.id}"
        ],
        "tags": [
          "server"
        ],
        "user_data": "#!/bin/bash\napt-get update\napt-get install -y unzip curl jq dnsutils\napt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository  \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" \napt-get update\napt-get install -y docker-ce docker-ce-cli containerd.io\nuseradd --system --home /etc/consul.d --shell /bin/false consul\nmkdir -p /etc/consul.d\nchown root:root /etc/consul.d\nchmod 0755 /etc/consul.d\nmkdir -p /opt/consul\nchown consul:consul /opt/consul\nchmod 0755 /opt/consul\ncurl -L https://releases.hashicorp.com/consul/1.7.1/consul_1.7.1_linux_amd64.zip -o /tmp/consul-1.7.1.zip\nchown root:root /tmp/consul-1.7.1.zip\nchmod 0644 /tmp/consul-1.7.1.zip\nunzip -x /tmp/consul-1.7.1.zip -d /usr/local/bin\nconsul -autocomplete-install\ncomplete -C /usr/local/bin/consul consul\ncat <<FILE_CONTENT | tee /etc/consul.d/config.hcl\nui = true\nbind = \"0.0.0.0\"\nadvertise_addr = \"{{GetPublicIP}}\"\ndatacenter = \"ams3\"\ndata_dir = \"/opt/consul\"\nFILE_CONTENT\nchown consul:consul /etc/consul.d/config.hcl\nchmod 0640 /etc/consul.d/config.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/server.hcl\nserver = true\nbootstrap_expect = 3\nFILE_CONTENT\nchown consul:consul /etc/consul.d/server.hcl\nchmod 0640 /etc/consul.d/server.hcl\ncat <<FILE_CONTENT | tee /etc/consul.d/join_lan.hcl\nretry_join = [\"provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\"]\nFILE_CONTENT\nchown consul:consul /etc/consul.d/join_lan.hcl\nchmod 0640 /etc/consul.d/join_lan.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/consul.service\n[Unit]\nAfter=network-online.target\nDescription=HashiCorp Consul - A service mesh solution\nDocumentation=https://www.consul.io/\nRequires=network-online.target\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/\nGroup=consul\nKillMode=process\nLimitNOFILE=65536\nRestart=on-failure\nType=notify\nUser=consul\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/consul.service\nchmod 0644 /etc/systemd/system/consul.service\nsystemctl start consul\nsystemctl enable consul\nmkdir -p /etc/nomad.d\nchown root:root /etc/nomad.d\nchmod 0755 /etc/nomad.d\nmkdir -p /opt/nomad/data\nchown root:root /opt/nomad/data\nchmod 0755 /opt/nomad/data\ncurl -L https://releases.hashicorp.com/nomad/0.10.0/nomad_0.10.0_linux_amd64.zip -o /tmp/nomad-0.10.0.zip\nchown root:root /tmp/nomad-0.10.0.zip\nchmod 0644 /tmp/nomad-0.10.0.zip\nunzip -x /tmp/nomad-0.10.0.zip -d /usr/local/bin\nrm /tmp/nomad-0.10.0.zip\ncat <<FILE_CONTENT | tee /etc/nomad.d/nomad.hcl\nadvertise {\n    http = \"{{GetPublicIP}}\"\n    rpc = \"{{GetPublicIP}}\"\n    serf = \"{{GetPublicIP}}\"\n}\n\nFILE_CONTENT\nchown root:root /etc/nomad.d/nomad.hcl\nchmod 0644 /etc/nomad.d/nomad.hcl\ncat <<FILE_CONTENT | tee /etc/nomad.d/datacenter.hcl\ndatacenter = ams3\nFILE_CONTENT\nchown root:root /etc/nomad.d/datacenter.hcl\nchmod 0644 /etc/nomad.d/datacenter.hcl\ncat <<FILE_CONTENT | tee /etc/systemd/system/nomad.service\n[Unit]\nDescription=nomad\nDocumentation=http://localhost\n[Service]\nExecReload=/usr/local/bin/consul reload\nExecStart=/usr/local/bin/nomad agent -server -bootstrap-expect=3 -data-dir=/opt/nomad/data -config=/etc/nomad.d provider=digitalocean api_token=${var.digitalocean_token} region=ams3 tag_name=server\nRestart=on-failure\nType=notify\n[Install]\nWantedBy=multi-user.target\nFILE_CONTENT\nchown root:root /etc/systemd/system/nomad.service\nchmod 0644 /etc/systemd/system/nomad.service\nsystemctl start nomad\nsystemctl enable nomad",
        "lifecycle": {
          "ignore_changes": [
            "user_data"
          ]
        }
      }
    },
    "digitalocean_ssh_key": {
      "smintz-0": {
        "name": "smintz-0",
        "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCk4ST4XhbBmZ3AKej/HWBBvodS/GBs3T6w6pP3WS2463QSOPnY42SVeH4AJZP3nVvvljeH7cYdFShastYOA6pkCxIVw7HSkE2xPLc+09n8bzaU3L8kHmjtfyZEQRxKmYTJA9dv0o3QYiJZgPWvUfGoLSYG4fqgD7KBZZrO+kygoAVby23mK3uPY67Z3mwQ8tB2JL3Fj00zbe+dTagHzXbudlUk28DvWBN59F8xLRZ0zI263MkkS0/1DuzmLlwj9XDfKaSxfSBOLBlAVF3CJ63dHLZ72JQ3ca5utFHkyK+WWymZskN+g3ahlvzb/cN/mMbSusVjvYg7+SDvPiN0waFP smintz@onavo"
      }
    },
    "random_pet": {
      "serverams31": {},
      "serverams32": {},
      "serverams33": {}
    },
    "tls_cert_request": {
      "serverams31": {
        "key_algorithm": "${tls_private_key.serverams31.algorithm}",
        "private_key_pem": "${tls_private_key.serverams31.private_key_pem}",
        "subject": {
          "common_name": "serverams31"
        }
      },
      "serverams32": {
        "key_algorithm": "${tls_private_key.serverams32.algorithm}",
        "private_key_pem": "${tls_private_key.serverams32.private_key_pem}",
        "subject": {
          "common_name": "serverams32"
        }
      },
      "serverams33": {
        "key_algorithm": "${tls_private_key.serverams33.algorithm}",
        "private_key_pem": "${tls_private_key.serverams33.private_key_pem}",
        "subject": {
          "common_name": "serverams33"
        }
      }
    },
    "tls_locally_signed_cert": {
      "serverams31": {
        "allowed_uses": [
          "key_encipherment",
          "digital_signature",
          "server_auth"
        ],
        "ca_cert_pem": "${tls_self_signed_cert.root.cert_pem}",
        "ca_key_algorithm": "${tls_private_key.root.algorithm}",
        "ca_private_key_pem": "${tls_private_key.root.private_key_pem}",
        "cert_request_pem": "${tls_cert_request.serverams31.cert_request_pem}",
        "validity_period_hours": 7776000
      },
      "serverams32": {
        "allowed_uses": [
          "key_encipherment",
          "digital_signature",
          "server_auth"
        ],
        "ca_cert_pem": "${tls_self_signed_cert.root.cert_pem}",
        "ca_key_algorithm": "${tls_private_key.root.algorithm}",
        "ca_private_key_pem": "${tls_private_key.root.private_key_pem}",
        "cert_request_pem": "${tls_cert_request.serverams32.cert_request_pem}",
        "validity_period_hours": 7776000
      },
      "serverams33": {
        "allowed_uses": [
          "key_encipherment",
          "digital_signature",
          "server_auth"
        ],
        "ca_cert_pem": "${tls_self_signed_cert.root.cert_pem}",
        "ca_key_algorithm": "${tls_private_key.root.algorithm}",
        "ca_private_key_pem": "${tls_private_key.root.private_key_pem}",
        "cert_request_pem": "${tls_cert_request.serverams33.cert_request_pem}",
        "validity_period_hours": 7776000
      }
    },
    "tls_private_key": {
      "root": {
        "algorithm": "ECDSA",
        "ecdsa_curve": "P384"
      },
      "serverams31": {
        "algorithm": "ECDSA",
        "ecdsa_curve": "P384"
      },
      "serverams32": {
        "algorithm": "ECDSA",
        "ecdsa_curve": "P384"
      },
      "serverams33": {
        "algorithm": "ECDSA",
        "ecdsa_curve": "P384"
      }
    },
    "tls_self_signed_cert": {
      "root": {
        "allowed_uses": [
          "key_encipherment",
          "digital_signature",
          "server_auth"
        ],
        "dns_names": [
          "protoconf.com"
        ],
        "is_ca_certificate": true,
        "key_algorithm": "${tls_private_key.root.algorithm}",
        "private_key_pem": "${tls_private_key.root.private_key_pem}",
        "validity_period_hours": 315360000,
        "subject": {
          "organization": "protoconf",
          "organizational_unit": "protocorp"
        }
      }
    }
  }
}
